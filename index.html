<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Trip OS</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F9F9F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #F9F9F7;
            --text-main: #1A1A1A;
            --text-sub: #666666;
            --accent: #C5A059;
            --white: #FFFFFF;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            background-color: var(--bg);
            font-family: 'Lato', 'Noto Serif TC', serif;
            margin: 0; padding: 0;
            color: var(--text-main);
            padding-bottom: calc(90px + var(--safe-bottom));
            -webkit-user-select: none; user-select: none;
        }

        /* --- Header (ÂèØÁ∑®ËºØ) --- */
        header {
            padding: max(20px, env(safe-area-inset-top)) 20px 10px;
            text-align: center;
            background: var(--bg);
            position: sticky; top: 0; z-index: 100;
        }
        .trip-title { font-size: 1.5rem; font-weight: 700; letter-spacing: 2px; margin-bottom: 5px; cursor: pointer; border-bottom: 1px dashed #ccc; display: inline-block;}
        .trip-year { font-size: 0.8rem; color: var(--text-sub); border: 1px solid #ccc; padding: 2px 8px; border-radius: 20px; display: inline-block; cursor: pointer; }

        /* --- Êó•ÊúüÈÅ∏ÂñÆ --- */
        .date-scroll {
            display: flex; gap: 15px; overflow-x: auto; padding: 10px 20px;
            scrollbar-width: none;
        }
        .date-scroll::-webkit-scrollbar { display: none; }
        
        .date-item {
            text-align: center; opacity: 0.4; transition: 0.3s; cursor: pointer; min-width: 50px;
        }
        .date-item.active { opacity: 1; transform: scale(1.1); }
        .date-day { font-size: 0.7rem; letter-spacing: 1px; font-weight: bold; }
        .date-num { font-size: 1.5rem; font-family: 'Lato', sans-serif; }
        .active .date-num { border-bottom: 2px solid var(--accent); padding-bottom: 2px; }

        /* --- ÊôÇÈñìËª∏Ë°åÁ®ã --- */
        .timeline-container { padding: 20px; position: relative; min-height: 200px;}
        .timeline-line {
            position: absolute; left: 36px; top: 20px; bottom: 20px;
            width: 1px; background: #ddd; z-index: 0;
        }

        .card {
            background: var(--white);
            border-radius: 4px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            position: relative;
            padding: 20px;
            border-left: 3px solid transparent;
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); }
        .card.special { border: 1px solid var(--accent); background: #FFFCF5; }

        .time-dot {
            position: absolute; left: -31px; top: 20px;
            width: 10px; height: 10px; background: var(--bg);
            border: 2px solid var(--text-sub); border-radius: 50%;
            z-index: 1;
        }
        .card.special .time-dot { border-color: var(--accent); background: var(--accent); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .card-time { font-family: 'Lato', sans-serif; font-size: 1.1rem; color: var(--accent); font-weight: bold; }
        .card-tag { font-size: 0.6rem; letter-spacing: 1px; text-transform: uppercase; color: #999; margin-bottom: 4px; display: block; }
        .card-title { font-size: 1.2rem; font-weight: 700; margin: 0; line-height: 1.4; }
        
        .card-meta { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; font-size: 0.9rem; color: #555; }
        .nav-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-outline {
            border: 1px solid #ccc; color: #333; padding: 8px 12px; border-radius: 4px;
            font-size: 0.8rem; text-decoration: none; display: flex; align-items: center; gap: 5px; flex: 1; justify-content: center;
        }

        /* --- Ë®òÂ∏≥Êú¨ --- */
        .wallet-header { text-align: center; padding: 20px; }
        .total-amount { font-size: 2.5rem; font-family: 'Lato', sans-serif; font-weight: 700; margin: 10px 0; }
        .total-sub { font-size: 0.9rem; color: #888; }
        
        .payer-filter { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
        .filter-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ddd;
            background: #fff; color: #999; font-family: 'Lato'; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .filter-btn.active { background: var(--text-main); color: #fff; border-color: var(--text-main); }

        .expense-item { display: flex; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid #eee; background: #fff; }
        .expense-info h4 { margin: 0; font-size: 1rem; }
        .expense-payer { font-size: 0.7rem; color: #fff; background: #ccc; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 5px; }

        /* --- Â∫ïÈÉ®Êí≠ÊîæÂô® --- */
        .player-bar {
            position: fixed; bottom: 15px; left: 15px; right: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 200; border: 1px solid rgba(0,0,0,0.05);
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
        .player-left { text-align: center; }
        .gps-icon { color: #d9534f; font-size: 24px; animation: pulse 2s infinite; }
        .player-center { flex: 1; text-align: center; border-left: 1px solid #eee; border-right: 1px solid #eee; margin: 0 15px; }
        .player-time { font-size: 1.5rem; font-family: 'Lato'; font-weight: 700; line-height: 1; }
        .player-status { font-size: 0.8rem; color: #888; margin-top: 4px; }
        .player-right { text-align: center; min-width: 60px; }
        .dist-val { font-family: 'Lato'; font-weight: 700; font-size: 0.9rem; }

        /* --- ÂΩàÁ™ó & Ëº∏ÂÖ•Ê°Ü --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; align-items: flex-end; }
        .modal.open { display: flex; animation: slideUp 0.3s; }
        .modal-sheet { background: #fff; width: 100%; border-radius: 20px 20px 0 0; padding: 30px 20px; padding-bottom: max(30px, env(safe-area-inset-bottom)); }
        
        .input-lg { border: none; border-bottom: 2px solid #000; font-size: 2rem; width: 100%; font-family: 'Lato'; padding: 10px 0; border-radius: 0; outline: none; }
        .input-label { font-size: 0.9rem; color: #888; margin-top: 20px; display: block; }
        .btn-black { background: #1A1A1A; color: #fff; width: 100%; padding: 15px; border-radius: 8px; font-size: 1rem; border: none; margin-top: 20px; cursor: pointer; }

        /* FAB */
        .fab-group { position: fixed; bottom: 110px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 199; }
        .fab { width: 50px; height: 50px; border-radius: 50%; background: #fff; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; color: #333; cursor: pointer; border: 1px solid #eee; }
        .fab.main { background: var(--text-main); color: #fff; }

        .view { display: none; }
        .view.active { display: block; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div class="trip-year" id="header-year" onclick="editHeader('year')">2026</div><br>
        <div class="trip-title" id="header-title" onclick="editHeader('title')">ÈªûÊ≠§Ë®≠ÂÆöÊóÖË°åÂêçÁ®±</div>
    </header>

    <div id="view-trip" class="view active">
        <div class="date-scroll">
            <div class="date-item active" onclick="setDay(1)">
                <div class="date-day">DAY</div><div class="date-num">1</div>
            </div>
            <div class="date-item" onclick="setDay(2)">
                <div class="date-day">DAY</div><div class="date-num">2</div>
            </div>
            <div class="date-item" onclick="setDay(3)">
                <div class="date-day">DAY</div><div class="date-num">3</div>
            </div>
            <div class="date-item" onclick="setDay(4)">
                <div class="date-day">DAY</div><div class="date-num">4</div>
            </div>
            <div class="date-item" onclick="setDay(5)">
                <div class="date-day">DAY</div><div class="date-num">5</div>
            </div>
        </div>

        <div class="timeline-container" id="itinerary-list">
            </div>
    </div>

    <div id="view-wallet" class="view">
        <div class="wallet-header">
            <div class="total-sub">Á∏ΩÈáëÈ°ç (Âè∞Âπ£)</div>
            <div class="total-amount" id="display-total">$0</div>
            
            <div class="payer-filter">
                <div class="filter-btn active" onclick="filterWallet('ALL')">ÂÖ®</div>
                <div class="filter-btn" onclick="filterWallet('M')">Êàë</div>
                <div class="filter-btn" onclick="filterWallet('W')">Â•π</div>
                <div class="filter-btn" onclick="filterWallet('G')">ÂÖ¨</div>
            </div>
        </div>
        <div style="background:#f0f0f0; height:10px;"></div>
        <div id="expense-list"></div>
    </div>

    <div id="view-info" class="view">
        <div style="padding:20px;">
            <div class="card">
                <h3 style="margin-top:0">Âú∞ÂúñÂ∞éËà™</h3>
                <div style="background:#eee; height:200px; border-radius:4px; display:flex; align-items:center; justify-content:center; color:#999;">
                    Google Maps Preview
                </div>
                <a href="https://www.google.com/maps/search/?api=1&query=SHIBUYA+SKY" target="_blank" class="btn-black" style="display:block; text-align:center; text-decoration:none; margin-top:10px;">ÈñãÂïü Google Maps</a>
            </div>

            <h4 style="margin-bottom:10px; color:#d9534f;">üö® Á∑äÊÄ•ËÅØÁµ°</h4>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div style="flex:1; background:#fff; padding:20px; text-align:center; box-shadow:var(--shadow); border-radius:8px;">
                    <div style="font-size:0.8rem; color:#888;">Ë≠¶ÂØü</div>
                    <div style="font-size:2rem; font-weight:bold; color:#d9534f;">110</div>
                </div>
                <div style="flex:1; background:#fff; padding:20px; text-align:center; box-shadow:var(--shadow); border-radius:8px;">
                    <div style="font-size:0.8rem; color:#888;">ÊïëË≠∑</div>
                    <div style="font-size:2rem; font-weight:bold; color:#d9534f;">119</div>
                </div>
            </div>
        </div>
    </div>

    <div class="fab-group">
        <div class="fab" onclick="switchView('view-info')"><span class="material-icons-outlined">info</span></div>
        <div class="fab" onclick="switchView('view-wallet')"><span class="material-icons-outlined">account_balance_wallet</span></div>
        <div class="fab main" onclick="switchView('view-trip')"><span class="material-icons-outlined">map</span></div>
        <div class="fab" style="background:#C5A059; color:#fff;" onclick="openAddModal()">+</div>
    </div>

    <div class="player-bar">
        <div class="player-left">
            <span class="material-icons-outlined gps-icon">my_location</span>
            <div style="font-size:0.6rem; font-weight:bold; margin-top:2px;">ON</div>
        </div>
        <div class="player-center">
            <div class="player-time" id="live-time">--:--</div>
            <div class="player-status" id="next-dest">ËºâÂÖ•‰∏≠...</div>
        </div>
        <div class="player-right">
            <span class="material-icons-outlined" style="font-size:20px;">near_me</span>
            <div class="dist-val" id="header-dest-val">Trip</div>
        </div>
    </div>

    <div id="modal-add" class="modal">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0;">Êñ∞Â¢ûÈ†ÖÁõÆ</h3>
                <span class="material-icons" onclick="closeModal()" style="cursor:pointer;">close</span>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button onclick="toggleAddType('trip')" id="btn-type-trip" class="btn-outline" style="background:#1A1A1A; color:#fff;">Ë°åÁ®ã</button>
                <button onclick="toggleAddType('expense')" id="btn-type-expense" class="btn-outline">Ë®òÂ∏≥</button>
            </div>

            <div id="form-trip">
                <span class="input-label">ÊôÇÈñì</span>
                <input type="time" id="trip-time" class="input-lg" style="font-size:1.5rem;" value="10:00">
                <span class="input-label">Âú∞Èªû / Ê®ôÈ°å</span>
                <input type="text" id="trip-title" class="input-lg" placeholder="Ëº∏ÂÖ•Âú∞Èªû">
                <span class="input-label">ÂÇôË®ª (ÈõªË©±/MapCode)</span>
                <input type="text" id="trip-note" class="input-lg" style="font-size:1rem;" placeholder="ÂÇôË®ª...">
                <button class="btn-black" onclick="saveTrip()">Âä†ÂÖ•Ë°åÁ®ã</button>
            </div>

            <div id="form-expense" style="display:none;">
                <span class="input-label">ÈáëÈ°ç (JPY)</span>
                <input type="number" id="exp-amount" class="input-lg" placeholder="2000" oninput="calcRate()">
                <div style="text-align:right; color:#888; margin-top:5px;">Á¥ÑÂè∞Âπ£ <span id="twd-preview">0</span></div>
                
                <span class="input-label">È†ÖÁõÆ</span>
                <input type="text" id="exp-note" class="input-lg" placeholder="ÊôöÈ§ê">
                
                <span class="input-label">Ë™∞‰ªòÁöÑÈå¢ (Payer)</span>
                <div class="payer-filter" style="justify-content:flex-start; margin-top:10px;">
                    <div class="filter-btn active" onclick="selectPayer(this, 'M')">Êàë</div>
                    <div class="filter-btn" onclick="selectPayer(this, 'W')">Â•π</div>
                    <div class="filter-btn" onclick="selectPayer(this, 'G')">ÂÖ¨</div>
                </div>
                <button class="btn-black" onclick="saveExpense()">ÂÑ≤Â≠òÊ∂àË≤ª</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚úÖ ÈáëÈë∞ (‰Ω†ÁöÑË®≠ÂÆö)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCbrzyXFiRYxGyt6crsRTQNQ5lfZnz65kA",
            authDomain: "tokyo-trip-2026-acfe6.firebaseapp.com",
            databaseURL: "https://tokyo-trip-2026-acfe6-default-rtdb.firebaseio.com",
            projectId: "tokyo-trip-2026-acfe6",
            storageBucket: "tokyo-trip-2026-acfe6.firebasestorage.app",
            messagingSenderId: "345730464055",
            appId: "1:345730464055:web:662b4c0391f893828c42b2",
            measurementId: "G-FKTG3ERB29"
        };

        // --- ÂàùÂßãÂåñ ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentDay = 1;
        let selectedPayer = 'M'; 
        const rate = 0.22;

        setInterval(() => {
            const now = new Date();
            document.getElementById('live-time').innerText = 
                now.getHours().toString().padStart(2,'0') + ':' + 
                now.getMinutes().toString().padStart(2,'0');
        }, 1000);

        // --- Ê®ôÈ°å/Âπ¥‰ªΩ Á∑®ËºØËàáÁõ£ËÅΩ ---
        function editHeader(type) {
            const newVal = prompt(type === 'year' ? "Ëº∏ÂÖ•Âπ¥‰ªΩ" : "Ëº∏ÂÖ•ÊóÖË°åÂêçÁ®±");
            if(newVal) {
                db.ref('settings/' + type).set(newVal);
            }
        }
        
        // Áõ£ËÅΩÊ®ôÈ°åËÆäÂåñ (ËÆìÂÖ©ÊîØÊâãÊ©üÂêåÊ≠•Ê®ôÈ°å)
        db.ref('settings').on('value', snap => {
            const val = snap.val();
            if(val) {
                if(val.title) {
                    document.getElementById('header-title').innerText = val.title;
                    document.title = val.title;
                    document.getElementById('header-dest-val').innerText = val.title;
                }
                if(val.year) document.getElementById('header-year').innerText = val.year;
            }
        });

        function setDay(day) {
            currentDay = day;
            document.querySelectorAll('.date-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            loadItinerary();
        }

        function loadItinerary() {
            const container = document.getElementById('itinerary-list');
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">Loading...</div>';

            db.ref('schedule').orderByChild('day').equalTo(currentDay).once('value', snap => {
                container.innerHTML = '<div class="timeline-line"></div>';
                const data = snap.val();
                if(!data) {
                    container.innerHTML += '<div style="text-align:center; padding:40px; color:#999;">Êú¨Êó•Â∞öÁÑ°Ë°åÁ®ã<br>ÈªûÂè≥‰∏ãËßí + Êñ∞Â¢û</div>';
                    return;
                }

                let items = [];
                for(let id in data) items.push({id, ...data[id]});
                items.sort((a,b) => a.time.localeCompare(b.time));

                items.forEach(item => {
                    const isSpecial = item.note && (item.note.includes("ÂøÖÂêÉ") || item.note.includes("ÈáçÈªû"));
                    const specialClass = isSpecial ? 'special' : '';
                    
                    const card = document.createElement('div');
                    card.className = `card ${specialClass}`;
                    card.innerHTML = `
                        <div class="time-dot"></div>
                        <div class="card-header">
                            <div>
                                <span class="card-tag">ACTIVITY</span>
                                <h3 class="card-title">${item.title}</h3>
                            </div>
                            <div class="card-time">${item.time}</div>
                        </div>
                        <div class="card-meta">
                            ${item.note ? `<div>${item.note}</div>` : ''}
                            <div class="nav-row">
                                <a href="https://www.google.com/maps/search/?api=1&query=${item.title}" target="_blank" class="btn-outline">
                                    <span class="material-icons-outlined" style="font-size:14px;">map</span> Map
                                </a>
                                <button class="btn-outline" onclick="delItem('schedule', '${item.id}')" style="flex:0;">√ó</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                    
                    if(items.indexOf(item) === 0) {
                        document.getElementById('next-dest').innerText = "ÂâçÂæÄ: " + item.title;
                    }
                });
            });
        }

        function loadWallet(filterPayer = 'ALL') {
            const listEl = document.getElementById('expense-list');
            listEl.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';
            
            db.ref('expenses').on('value', snap => {
                listEl.innerHTML = '';
                let totalTWD = 0;
                const data = snap.val();
                
                if(data) {
                    let items = [];
                    for(let id in data) items.push(data[id]);
                    items.reverse();

                    items.forEach(item => {
                        if(filterPayer !== 'ALL' && item.payer !== filterPayer) return;

                        const twd = Math.round(item.amount * rate);
                        totalTWD += twd;
                        
                        const div = document.createElement('div');
                        div.className = 'expense-item';
                        div.innerHTML = `
                            <div class="expense-info">
                                <h4>${item.note}</h4>
                                <div style="font-size:0.8rem; color:#888;">¬•${item.amount}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:bold;">$${twd.toLocaleString()}</div>
                                <div style="margin-top:5px;">
                                    <span class="expense-payer">${item.payer || 'M'}</span>
                                </div>
                            </div>
                        `;
                        listEl.appendChild(div);
                    });
                }
                document.getElementById('display-total').innerText = '$' + totalTWD.toLocaleString();
            });
        }

        function filterWallet(payer) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadWallet(payer);
        }

        function openAddModal() {
            document.getElementById('modal-add').classList.add('open');
        }
        function closeModal() {
            document.getElementById('modal-add').classList.remove('open');
        }
        function toggleAddType(type) {
            document.getElementById('form-trip').style.display = type === 'trip' ? 'block' : 'none';
            document.getElementById('form-expense').style.display = type === 'expense' ? 'block' : 'none';
            document.getElementById('btn-type-trip').style.background = type === 'trip' ? '#1A1A1A' : '#fff';
            document.getElementById('btn-type-trip').style.color = type === 'trip' ? '#fff' : '#333';
            document.getElementById('btn-type-expense').style.background = type === 'expense' ? '#1A1A1A' : '#fff';
            document.getElementById('btn-type-expense').style.color = type === 'expense' ? '#fff' : '#333';
        }

        function saveTrip() {
            const title = document.getElementById('trip-title').value;
            if(!title) return;
            db.ref('schedule').push({
                day: currentDay,
                time: document.getElementById('trip-time').value,
                title: title,
                note: document.getElementById('trip-note').value
            });
            closeModal();
            loadItinerary();
        }

        function selectPayer(el, payer) {
            selectedPayer = payer;
            document.querySelectorAll('#form-expense .filter-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        function calcRate() {
            const val = document.getElementById('exp-amount').value;
            document.getElementById('twd-preview').innerText = Math.round(val * rate);
        }

        function saveExpense() {
            const amt = document.getElementById('exp-amount').value;
            if(!amt) return;
            db.ref('expenses').push({
                amount: amt,
                note: document.getElementById('exp-note').value,
                payer: selectedPayer,
                date: new Date().toLocaleDateString()
            });
            closeModal();
        }

        function delItem(path, id) {
            if(confirm('Á¢∫ÂÆöÂà™Èô§?')) {
                db.ref(path + '/' + id).remove();
                if(path === 'schedule') loadItinerary();
            }
        }

        function switchView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        loadItinerary();
        loadWallet();
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>